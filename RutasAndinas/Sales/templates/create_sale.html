{% extends 'base.html' %}

{% block title %}Venta{% endblock %}

{% load static %}

{% block content %}
<!-- Bootstrap JS (necesario para dropdowns) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

<div class="container-fluid d-flex justify-content-center align-items-center min-vh-100 px-3">
    <div class="card shadow-lg rounded-4 p-4 m-4 col-lg-8 col-md-10 col-sm-12" style="background-color: white;">
        <h2 class="text-center fw-bold mb-4" style="color: #34495E;">Compra de Plan: {{ plan.name }}</h2>
        <hr class="border-1 opacity-75">

        <p class="fs-5"><strong>Precio base por persona:</strong> ${{ price_per_person }}</p>

        <form method="post">
            {% csrf_token %}
            <!-- Opciones adicionales si el plan las incluye -->
            <h4 class="fw-semibold mt-3 mb-2" style="color: #34495E;">Incluye:</h4>
            <div class="mb-3">
                {% if plan.has_transport %}
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="include_transport" id="include_transport">
                    <label class="form-check-label" for="include_transport">
                        Incluir Transporte (+25%)
                    </label>
                </div>
                {% endif %}
                {% if plan.has_meal %}
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="include_meal" id="include_meal">
                    <label class="form-check-label" for="include_meal">
                        Incluir Comida (+10%)
                    </label>
                </div>
                {% endif %}
                {% if plan.has_guide %}
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="include_guide" id="include_guide">
                    <label class="form-check-label" for="include_guide">
                        Incluir Guía (+5%)
                    </label>
                </div>
                {% endif %}
            </div>

            <!-- Selección de número de personas -->
            <div class="mb-3">
                <label for="num_people" class="form-label">Número de Personas:</label>
                <input type="number" name="num_people" id="num_people" min="1" value="1" class="form-control" required>
            </div>

            <!-- Selección de método de pago -->
            <div class="mb-3">
                <label for="payment_method" class="form-label">Método de Pago:</label>
                <select name="payment_method" id="payment_method" class="form-select" required>
                    <option value="tarjeta">Tarjeta</option>
                    <option value="pse">PSE</option>
                    <option value="efecty">Efecty</option>
                </select>
            </div>

            <!-- Selección de fecha del plan -->
            <div class="mb-3">
                <label for="selected_date" class="form-label">Fecha del Plan:</label>
                <select name="selected_date" id="selected_date" class="form-select" required>
                    {% for date in plan_dates %}
                    <option value="{{ date.plan_date }}">{{ date.plan_date }}</option>
                    {% empty %}
                    <option>No hay fechas disponibles</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Precios calculados dinámicamente -->
            <div class="mb-3">
                <label for="payment_method" class="form-label">Método de Pago:</label>
                <select name="payment_method" id="payment_method" class="form-select" required>
                    <option value="tarjeta">Tarjeta</option>
                    <option value="pse">PSE</option>
                    <option value="efecty">Efecty</option>
                </select>
            </div>

            <div class="mb-3">
                <label for="selected_date" class="form-label">Fecha del Plan:</label>
                <select name="selected_date" id="selected_date" class="form-select" required>
                    {% for date in plan_dates %}
                    <option value="{{ date.plan_date }}">{{ date.plan_date }}</option>
                    {% empty %}
                    <option>No hay fechas disponibles</option>
                    {% endfor %}
                </select>
            </div>
            <div class="mb-3">
                <strong>Total por persona:</strong> $<span id="price-per-person">{{ price_per_person|floatformat:2 }}</span>
            </div>
            <div class="mb-3">
                <strong>Total:</strong> $<span id="total-price">{{ total_price|floatformat:2 }}</span>
            </div>

            <button type="submit" class="btn btn-primary">Confirmar Compra</button>
        </form>
        <a href="{% url 'detailsPlan' plan.plan_id %}" class="btn btn-secondary">Cancelar</a>
    </div>
</div>

<!-- Estilo personalizado para los checkboxes -->
<style>
    .form-check-input:checked {
        background-color: #1ABC9C;
        border-color: #1ABC9C;
    }
</style>

<!-- Script para actualizar precios dinámicamente según las selecciones -->
<script>
    document.addEventListener("DOMContentLoaded", function() {
        // Obtener los elementos del DOM
        const pricePerPerson = parseFloat("{{ price_per_person }}"); // Precio base por persona
        const transportCheckbox = document.getElementById('include_transport');
        const mealCheckbox = document.getElementById('include_meal');
        const guideCheckbox = document.getElementById('include_guide');
        const numPeopleInput = document.getElementById('num_people');
        const totalPriceSpan = document.getElementById('total-price');
        const pricePerPersonSpan = document.getElementById('price-per-person');

        // Función para actualizar los cálculos
        function updateTotal() {
            let totalPricePerPerson = pricePerPerson;

            // Verificar y aplicar los incrementos de precio
            if (transportCheckbox && transportCheckbox.checked) {
                totalPricePerPerson *= 1.25;
            }
            if (mealCheckbox && mealCheckbox.checked) {
                totalPricePerPerson *= 1.10;
            }
            if (guideCheckbox && guideCheckbox.checked) {
                totalPricePerPerson *= 1.05;
            }

            // Actualizar el precio por persona
            pricePerPersonSpan.textContent = totalPricePerPerson.toFixed(2);

            // Obtener el número de personas y calcular el total
            const numPeople = parseInt(numPeopleInput.value, 10);
            const totalPrice = totalPricePerPerson * numPeople;

            // Actualizar el total
            totalPriceSpan.textContent = totalPrice.toFixed(2);
        }

        // Añadir event listeners solo si el elemento existe
        if (transportCheckbox) {
            transportCheckbox.addEventListener('change', updateTotal);
        }
        if (mealCheckbox) {
            mealCheckbox.addEventListener('change', updateTotal);
        }
        if (guideCheckbox) {
            guideCheckbox.addEventListener('change', updateTotal);
        }
        numPeopleInput.addEventListener('input', updateTotal);

        // Ejecutar al cargar la página para mostrar el cálculo inicial
        updateTotal();
    });
</script>
{% endblock %}
