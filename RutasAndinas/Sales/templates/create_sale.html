{% block content %}
<div class="container mt-4">
    <h2>Compra de Plan: {{ plan.name }}</h2>
    <p>Precio base por persona: ${{ price_per_person }}</p>

    <form method="post">
        {% csrf_token %}
        <h4>Incluye:</h4>
        <ul>
            {% if plan.has_transport %}
            <div class="form-check">
                <input class="form-check-input" type="checkbox" name="include_transport" id="include_transport">
                <label class="form-check-label" for="include_transport">
                    Incluir Transporte (+25%)
                </label>
            </div>
            {% endif %}
            {% if plan.has_meal %}
            <div class="form-check">
                <input class="form-check-input" type="checkbox" name="include_meal" id="include_meal">
                <label class="form-check-label" for="include_meal">
                    Incluir Comida (+10%)
                </label>
            </div>
            {% endif %}
            {% if plan.has_guide %}
            <div class="form-check">
                <input class="form-check-input" type="checkbox" name="include_guide" id="include_guide">
                <label class="form-check-label" for="include_guide">
                    Incluir Guía (+5%)
                </label>
            </div>
            {% endif %}
        </ul>

        <div class="mb-3">
            <label for="num_people" class="form-label">Número de Personas:</label>
            <input type="number" name="num_people" id="num_people" min="1" value="1" class="form-control" required>
        </div>

        <div class="mb-3">
            <label for="payment_method" class="form-label">Método de Pago:</label>
            <select name="payment_method" id="payment_method" class="form-select" required>
                <option value="tarjeta">Tarjeta</option>
                <option value="pse">PSE</option>
                <option value="efecty">Efecty</option>
            </select>
        </div>

        <div class="mb-3">
            <label for="selected_date" class="form-label">Fecha del Plan:</label>
            <select name="selected_date" id="selected_date" class="form-select" required>
                {% for date in plan_dates %}
                <option value="{{ date.plan_date }}">{{ date.plan_date }}</option>
                {% empty %}
                <option>No hay fechas disponibles</option>
                {% endfor %}
            </select>
        </div>
        <div class="mb-3">
            <strong>Total por persona:</strong> $<span id="price-per-person">{{ price_per_person|floatformat:2 }}</span>
        </div>
        <div class="mb-3">
            <strong>Total:</strong> $<span id="total-price">{{ total_price|floatformat:2 }}</span>
        </div>

        <button type="submit" class="btn btn-primary">Confirmar Compra</button>
    </form>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
    // Obtener los elementos del DOM
    const pricePerPerson = parseFloat("{{ price_per_person }}"); // Precio base por persona
    const transportCheckbox = document.getElementById('include_transport');
    const mealCheckbox = document.getElementById('include_meal');
    const guideCheckbox = document.getElementById('include_guide');
    const numPeopleInput = document.getElementById('num_people');
    const totalPriceSpan = document.getElementById('total-price');
    const pricePerPersonSpan = document.getElementById('price-per-person');

    // Función para actualizar los cálculos
    function updateTotal() {
        let totalPricePerPerson = pricePerPerson;

        // Verificar y aplicar los incrementos de precio
        if (transportCheckbox && transportCheckbox.checked) {
            totalPricePerPerson *= 1.25;
        }
        if (mealCheckbox && mealCheckbox.checked) {
            totalPricePerPerson *= 1.10;
        }
        if (guideCheckbox && guideCheckbox.checked) {
            totalPricePerPerson *= 1.05;
        }

        // Actualizar el precio por persona
        pricePerPersonSpan.textContent = totalPricePerPerson.toFixed(2);

        // Obtener el número de personas y calcular el total
        const numPeople = parseInt(numPeopleInput.value, 10);
        const totalPrice = totalPricePerPerson * numPeople;

        // Actualizar el total
        totalPriceSpan.textContent = totalPrice.toFixed(2);
    }

    // Añadir event listeners solo si el elemento existe
    if (transportCheckbox) {
        transportCheckbox.addEventListener('change', updateTotal);
    }
    if (mealCheckbox) {
        mealCheckbox.addEventListener('change', updateTotal);
    }
    if (guideCheckbox) {
        guideCheckbox.addEventListener('change', updateTotal);
    }
    numPeopleInput.addEventListener('input', updateTotal);

    // Ejecutar al cargar la página para mostrar el cálculo inicial
    updateTotal();
});
</script>

{% endblock %}