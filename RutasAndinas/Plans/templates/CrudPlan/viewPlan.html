{% block content %}
<div class="container mt-4">
    <h2>Detalles del Plan</h2>

    <div class="mb-3">
        <strong>Nombre del Plan:</strong> {{ plan.name }}
    </div>

    <div class="mb-3">
        <div>
            {% for picture in pictures %}
                <img src="{{ picture.picture.url }}" alt="Imagen del Plan" width="150" class="me-2">
            {% empty %}
                <p>No hay imágenes disponibles.</p>
            {% endfor %}
        </div>
    </div>

    <div class="mb-3">
        <strong>Descripción:</strong>
        <p>{{ plan.description }}</p>
    </div>

    <div class="mb-3">
        <strong>Precio:</strong> ${{ plan.price }}
    </div>

    <div class="mb-3">
        <strong>Número de Cupos:</strong> {{ plan.places }}
    </div>

    <div class="mb-3">
        <strong>Categoría:</strong> {{ plan.category_id.category }}
    </div>

    <div class="mb-3">
        <strong>Opciones Adicionales:</strong>
        <ul>
            <li>Transporte: {% if plan.has_transport %} Sí {% else %} No {% endif %}</li>
            <li>Comida: {% if plan.has_meal %} Sí {% else %} No {% endif %}</li>
            <li>Guía: {% if plan.has_guide %} Sí {% else %} No {% endif %}</li>
        </ul>
    </div>

    <div class="mb-3">
        <strong>Fechas Disponibles:</strong>
        <ul>
            {% for date_obj in plan_dates %}
                <li>{{ date_obj.plan_date }}</li>  
            {% empty %}
                <li>No hay fechas disponibles</li>
            {% endfor %}
        </ul>
    </div>

    <a href="{% url 'editPlan' plan.plan_id %}">
        <button>Editar</button>
    </a>
    <form action="{% url 'deletePlan' plan.plan_id %}" method="POST" style="display:inline;">
        {% csrf_token %}
        <button type="submit" onclick="return confirm('¿Estás seguro de eliminar este plan?');">
            Eliminar
        </button>
    </form>

    <div class="mb-3">
        <h4>Reseñas</h4>
        {% if reviews %}
            {% for review in reviews %}
                <div class="border p-2 mb-2">
                    <p><strong>{{ review.user_id.username }}</strong></p>
                    <h3>
                        <span class="star-rating stary">
                            {% for i in "12345" %}
                                {% if i <= review.rate|stringformat:"s" %}
                                    &#9733;
                                {% else %}
                                    &#9734;
                                {% endif %}
                            {% endfor %}
                        </span>
                        ({{ review.rate }}/5)
                    </h3>
                    <p>{{ review.content }}</p>
    
                    {% if review.user_id == request.user %}
                        <button class="btn btn-warning btn-sm edit-btn" data-review-id="{{ review.review_id }}">Editar</button>
                        <button class="btn btn-danger btn-sm delete-btn" data-review-id="{{ review.review_id }}">Eliminar</button>
                        
                        <!-- Formulario de edición -->
                        <div id="edit-form-{{ review.review_id }}" class="edit-form" style="display: none;">
                            <form method="POST" action="{% url 'reviews:edit_review' plan.plan_id review.review_id %}">
                                {% csrf_token %}
                                <div class="mb-3">
                                    <label for="rate" class="form-label">Nueva Calificación:</label>
                                    <div id="star-container" class="mb-2">
                                        {% for i in "12345" %}
                                            <span class="star" data-value="{{ i }}">&#9734;</span>
                                        {% endfor %}
                                    </div>
                                    <input type="hidden" id="rate" name="rate" value="0" required>
                                </div>
                                <div class="mb-3">
                                    <label for="content" class="form-label">Nuevo Comentario:</label>
                                    <textarea name="content" rows="2" class="form-control" required>{{ review.content }}</textarea>
                                </div>
                                <button type="submit" class="btn btn-success btn-sm">Guardar</button>
                                <button type="button" class="btn btn-secondary btn-sm cancel-btn">Cancelar</button>
                            </form>
                        </div>
    
                        <!-- Formulario de eliminación -->
                        <form id="delete-form-{{ review.review_id }}" method="POST" action="{% url 'reviews:delete_review' plan.plan_id review.review_id %}" style="display: none;">
                            {% csrf_token %}
                        </form>
                    {% endif %}
                </div>
            {% endfor %}
        {% else %}
            <p>No hay reseñas para este plan.</p>
        {% endif %}
    </div>   

    <a href="{% url 'list' %}" class="btn btn-secondary">Volver</a>
</div>
<script>
    const stars = document.querySelectorAll('.star');
    const rateInput = document.getElementById('rate');

    stars.forEach((star, index) => {
        star.addEventListener('click', () => {
            // Actualiza el valor del input oculto
            rateInput.value = index + 1;
            // Resetea las estrellas
            stars.forEach((s, i) => {
                s.innerHTML = i <= index ? '&#9733;' : '&#9734;';
            });
        });
    });
</script>

<script>
    // Mostrar y ocultar el formulario de edición
    document.querySelectorAll('.edit-btn').forEach(button => {
        button.addEventListener('click', function () {
            const reviewId = this.getAttribute('data-review-id');
            const form = document.getElementById(`edit-form-${reviewId}`);
            form.style.display = form.style.display === 'none' ? 'block' : 'none';
        });
    });

    // Cancelar edición
    document.querySelectorAll('.cancel-btn').forEach(button => {
        button.addEventListener('click', function () {
            this.closest('.edit-form').style.display = 'none';
        });
    });

    // Eliminar reseña con confirmación
    document.querySelectorAll('.delete-btn').forEach(button => {
        button.addEventListener('click', function () {
            const reviewId = this.getAttribute('data-review-id');
            if (confirm("¿Estás seguro de que deseas eliminar esta reseña?")) {
                document.getElementById(`delete-form-${reviewId}`).submit();
            }
        });
    });
</script>

<style>
    .stary {
        font-size: 2rem;
        color: #ffc107;
    }
    .star {
        font-size: 2rem;
        cursor: pointer;
        color: #ffc107;
    }
    .star:hover {
        transform: scale(1.2);
    }
</style>

{% endblock %}
